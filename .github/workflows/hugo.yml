name: test hugo

on: [pull_request]

env:
  NODE_VERSION: 22
  HUGO_VERSION: 0.126.1

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true # Fetch Hugo themes (true OR recursive)
          fetch-depth: 2 # Fetch enough history for HEAD~1

      - name: Get changed files key
        id: changed-files-key
        run: |
          git diff --name-only HEAD~1 HEAD | tr '\n' ',' > changed_files.txt
          echo "files=$(cat changed_files.txt)" >> $GITHUB_OUTPUT

      - name: Calc hash
        id: calc-hash
        run: |
          find . -path ./.git -prune -o -type f -print0 > files.txt
          cat files.txt | sort -z | xargs -0 md5sum | head -c 40 > hash.txt
          hash_value=$(cat hash.txt)
          echo "result=$hash_value" >> $GITHUB_OUTPUT

      - name: Debug Cache Key
        run: |
          echo "calc-hash output: ${{ steps.calc-hash.outputs.result }}"
          echo "changed-files output: ${{ steps.changed-files-key.outputs.files }}"

      - name: Cache checkout
        id: cache-checkout
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}
          key: ${{ runner.os }}-checkout-${{ steps.calc-hash.outputs.result }}-${{ steps.changed-files-key.outputs.files }}
          restore-keys: |
            ${{ runner.os }}-checkout-${{ steps.calc-hash.outputs.result }}-
            ${{ runner.os }}-checkout-

      - name: Lint Filenames
        uses: julie-ng/lowercase-linter@v1
        id: lint_filenames
        continue-on-error: false
        with:
          path: "."
          pr-comment: true
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  test-linux:
    needs: lint
    name: Build hugo on Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true # Fetch Hugo themes (true OR recursive)
          fetch-depth: 2 # Fetch enough history for HEAD~1. Crucial: .git dir must exist before key calculation.

      - name: Get changed files key
        id: changed-files-key
        run: |
          git diff --name-only HEAD~1 HEAD | tr '\n' ',' > changed_files.txt
          echo "files=$(cat changed_files.txt)" >> $GITHUB_OUTPUT

      - name: Calc hash
        id: calc-hash
        run: |
          find . -path ./.git -prune -o -type f -print0 > files.txt
          cat files.txt | sort -z | xargs -0 md5sum | head -c 40 > hash.txt
          hash_value=$(cat hash.txt)
          echo "result=$hash_value" >> $GITHUB_OUTPUT

      - name: Debug Cache Key
        run: |
          echo "calc-hash output: ${{ steps.calc-hash.outputs.result }}"
          echo "changed-files output: ${{ steps.changed-files-key.outputs.files }}"

      - name: Cache checkout
        id: cache-checkout
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}
          key: ${{ runner.os }}-checkout-${{ steps.calc-hash.outputs.result }}-${{ steps.changed-files-key.outputs.files }}
          restore-keys: |
            ${{ runner.os }}-checkout-${{ steps.calc-hash.outputs.result }}-
            ${{ runner.os }}-checkout-

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: Build Hugo
        run: hugo --environment=production --minify --templateMetrics --logLevel info

  # test-windows:
  #   needs: lint
  #   name: Build hugo on Windows
  #   runs-on: windows-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #       with:
  #         submodules: true # Fetch Hugo themes (true OR recursive)
  #         fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod

  #     - name: Setup Hugo
  #       uses: peaceiris/actions-hugo@v2
  #       with:
  #         hugo-version: ${{ env.HUGO_VERSION }}


  #     - name: Build
  #       run: hugo -v
